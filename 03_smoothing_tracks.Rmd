---
output: html_document
editor_options: 
  chunk_output_type: console
---

# Smoothing tracks and aggregating dat

## Prepare libraries {-}

```{r prep_libs_02_01}
# prep libs
library(data.table)
library(atlastools)
library(ggplot2)
library(patchwork)

# prepare a palette
pal <- RColorBrewer::brewer.pal(4, "Set1")
```


## Reading in data {-}

Here we read the simulated data in. The limits of the coordinates are 0 and 1, so we add a few extraneous coordinates within a plausible distance to demonstrate the basic forms of filtering. We also assign a fictional _NBS_ value ranging between 2 and 6 to demonstrate filtering on covariates. Finally, we introduce a 'reflection', a phenomenon that results when a TOA system's position likelihood estimator shifts the real position by a large distance for an extended duration.

```{r read_sim_data_2}
# read in the data
data <- fread("data/data_sim.csv")[5000:10000, ]
data[, window_size := NA]
# data with small scale errors but no reflections or outliers
data_errors <- fread("data/data_no_reflection.csv")
data_errors[, window_size := 0]
```

## Applying a median smooth

```{r}
# smooth the data
list_of_smooths <- lapply(c(3, 5, 11, 21), function(z) {
  data_copy <- copy(data_errors)
  data_copy <- atl_median_smooth(data = data_copy,
                    x = "x", 
                    y = "y",
                    time = "time",
                    moving_window = z)
  data_copy[, window_size := z]
})
```

```{r}
# prepare data to plot
# make list of data to plot
data_plot <- append(list(data_errors), list_of_smooths)

figure_median_smooth <- 
  mapply(function(df, col) {
    ggplot()+
      geom_point(data = df,
                 aes(x, y),
                 size = 0.5,
                 show.legend = FALSE,
                 col = col,
                 shape = 16)+
      geom_path(data = data,
                aes(x, y),
                lwd = 0.2,
                col = pal[4])+
      scale_colour_distiller(
        palette = "YlGnBu",
        na.value = "grey20")+
      coord_cartesian(expand = T,
                  ylim = c(0.6, 0.8)) +
      ggthemes::theme_map()+
      theme(plot.background = element_rect(fill = NA))
}, data_plot, c("grey", RColorBrewer::brewer.pal(7, "Greens")[2:5]),
SIMPLIFY = F)

# make basic plot with rectangle
fig_bounds <- ggplot()+
  geom_path(data = data,
            aes(x, y),
            col = pal[4])+
  geom_hline(yintercept = c(0.6, 0.8),
             col = "grey20",
             lty = 2, lwd = 0.2)+
  coord_equal() +
  ggthemes::theme_map()

# append to first figure
figure_median_smooth[[1]] <-
  figure_median_smooth[[1]]+
  annotation_custom(grob = ggplotGrob(fig_bounds),
                    ymin = 0.6, ymax = 0.8,
                    xmin = 0.55, xmax = 0.7)

# wrap plots
fig_median_smooth <- wrap_plots(figure_median_smooth, ncol = 3)+
  plot_annotation(tag_levels = "a",
                  tag_prefix = "(",
                  tag_suffix = ")") &
  theme(plot.tag = element_text(face = "bold"))


fig_median_smooth
# save figure
ggsave(fig_median_smooth, filename = "figures/fig_median_smooth.png",
       width = 170, height = 90, units = "mm")
```

## Aggregating data

```{r}
# choose the data
data_agg <- copy(data)

list_of_agg <- lapply(c(10, 30, 120), function(z) {
  data_agg <- atl_thin_data(data = data_agg,
                            interval = z,
                            method = "aggregate")
  data_agg[, interval := z]
  
})
```

```{r}
# plot
data_plot <- append(list(data[, `:=`(SD = 0, interval = NA)]), list_of_agg)

# add offset
data_plot <- mapply(FUN = function(df, offset) {
  df[, x := x + offset]
}, data_plot, seq(from = 0, to = 1, length.out = length(data_plot)),
SIMPLIFY = FALSE)

data_plot <- rbindlist(data_plot, fill = TRUE)

plot_figure <- ggplot(data = data_plot)+
  geom_point(aes(x, y, size = SD),
             colour = "darkblue",
             alpha = 0.5,
             shape = 16, show.legend = F)+
  geom_path(aes(x, y,
                group = interval,
                col = interval),
            col = "red",
            show.legend = FALSE)+
  annotate(x = 0.6 + seq(0, 1, length.out = 4),
           y = 1.05,
           label = glue::glue('({letters[seq(4)]})'),
           geom = "text",
           fontface = "bold")+
  coord_equal()+
  theme_test()+
  theme(axis.text = element_blank(),
        axis.title = element_blank())

plot_figure

# save figure
ggsave(plot_figure, filename = "figures/fig_aggregate_data.png",
       width = 185, height = 90, units = "mm")
```

