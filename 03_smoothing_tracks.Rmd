---
output: html_document
editor_options: 
  chunk_output_type: console
---

# Smoothing tracks and aggregating dat

## Prepare libraries {-}

```{r prep_libs_02_01}
library(data.table)
library(atlastools)
library(ggplot2)
```


## Reading in data {-}

Here we read the simulated data in. The limits of the coordinates are 0 and 1, so we add a few extraneous coordinates within a plausible distance to demonstrate the basic forms of filtering. We also assign a fictional _NBS_ value ranging between 2 and 6 to demonstrate filtering on covariates. Finally, we introduce a 'reflection', a phenomenon that results when a TOA system's position likelihood estimator shifts the real position by a large distance for an extended duration.

```{r read_sim_data_2}
# read in the data
data <- fread("data/data_sim.csv")[5000:10000, ]
# data with small scale errors but no reflections or outliers
data_errors <- fread("data/data_no_reflection.csv")
```

## Applying a median smooth

```{r}
# smooth the data
list_of_smooths <- lapply(c(3, 5, 11, 21), function(z) {
  data_copy <- copy(data_errors)
  atl_median_smooth(data = data_copy,
                    x = "x", 
                    y = "y",
                    time = "time",
                    moving_window = z)
})
```

```{r}
# prepare data to plot
# make list of data to plot
data_plot <- append(list(data, data_errors), list_of_smooths)

# make plot list
plots <- lapply(data_plot, function(df) {
  ggplot(data = df)+
    
    geom_point(aes(x, y),
              col = "grey", 
              alpha = 0.1,
              shape = 16)+
    geom_path(aes(x, y),
              col = "red", 
              alpha = 0.5)+
    coord_equal(xlim = c(0.5, 1),
                ylim = c(0.5, 1)) +
    theme_test()+
    theme(axis.text = element_blank(),
          axis.title = element_blank())
})

# wrap plots
plot_figure <- wrap_plots(plots) +
  plot_annotation(tag_levels = "a",
                  tag_prefix = "(",
                  tag_suffix = ")") &
  theme(plot.tag = element_text(face = "bold"))

plot_figure

# save figure
ggsave(plot_figure, filename = "figures/fig_median_smooth.png",
       width = 185, height = 185 * 2 / 3, units = "mm")
```

## Aggregating data

```{r}
# choose the data
data_agg <- copy(data)

list_of_agg <- lapply(c(10, 30, 120), function(z) {
  atl_thin_data(data = data_agg,
                interval = z,
                method = "aggregate")
})
```

```{r}
# plot
data_plot <- append(list(data[, SD := 0]), list_of_agg)

# make plot list
plots <- lapply(data_plot, function(df) {
  ggplot(data = df)+
    
    geom_point(aes(x, y, size = SD), 
              alpha = 0.5,
              shape = 16, show.legend = F)+
    geom_path(aes(x, y),
              col = "red", 
              alpha = 1, lwd = 0.2)+
    coord_equal()+
    theme_test()+
    theme(axis.text = element_blank(),
          axis.title = element_blank())
})

# wrap plots
plot_figure <- wrap_plots(plots, ncol = 4) +
  plot_annotation(tag_levels = "a",
                  tag_prefix = "(",
                  tag_suffix = ")") &
  theme(plot.tag = element_text(face = "bold"))

plot_figure

# save figure
ggsave(plot_figure, filename = "figures/fig_aggregate_data.png",
       width = 185, height = 90, units = "mm")
```

