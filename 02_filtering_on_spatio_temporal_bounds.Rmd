---
output: html_document
editor_options: 
  chunk_output_type: console
---

This section covers:

1. Simple spatio-temporal filtering of point data to remove gross positioning errors,

2. Filtering positions on covariates that may be associated with increased positioning error,

3. Filtering movement tracks using the 'non-movement' approach to remove implausible movement segments, and

4. The challenge of reflected positions, and how it can be addressed.

# Filtering data

## Prepare libraries {-}

```{r prep_libs_02_01}
library(data.table)
library(atlastools)
```


## Introducing errors {-}

Here we read the simulated data in. The limits of the coordinates are 0 and 1, so we add a few extraneous coordinates within a plausible distance to demonstrate the basic forms of filtering. We also assign a fictional _NBS_ value ranging between 2 and 6 to demonstrate filtering on covariates. Finally, we introduce a 'reflection', a phenomenon that results when a TOA system's position likelihood estimator shifts the real position by a large distance for an extended duration.

```{r read_sim_data}
# read in the data
data <- fread("data/data_sim.csv")

# add some gross positioning errors
data[sample(nrow(data), 100), c("x", "y") := lapply(.SD,
                                                   function(z) {
                                                     z + rnorm(100, sd = 0.1)
                                                   }),
     .SDcols = c("x", "y")]

# add a fictional NBS covariate
data[, NBS := floor(rnorm(n = nrow(data), mean = 4, sd = 1))]
```

## Excluding gross positioning errors

First we remove gross positioning errors using a bounding box filter, i.e., knowing or assuming the real bounds of the movement track (in this case, 0 -- 1), we remove all positions outside those bounds.

```{r}
# remove positions outside a bounding box
data_inside_bbox <- data.table::copy(data)

# NB: set remove_inside to FALSE
data_inside_bbox <- atlastools::atl_filter_bounds(data = data,
                                                  x_range = c(0, 1),
                                                  y_range = c(0, 1),
                                                  remove_inside = FALSE)
```

## Excluding data on covariate values

Some position covariates may be indicators of unreliable data, due to being linked with increased spatial uncertainty. The number of base-stations (NBS) used to localise a transmitting tag in ATLAS systems is one such covariate, with a minimum of three base-stations required for a two-dimensional localisation. Here, we remove all positions with < 3 base-stations.

```{r}
# remove positions with few base stations
data_many_nbs <- copy(data_inside_bbox)
data_many_nbs <- atl_filter_covariates(data_many_nbs, 
                                       filters = c("NBS >= 3"))
```

## The non-movement approach

Bjorneraas et al. (2010) describe intuitive filtering steps for trajectories that are based in the biology of the study species (moose _Alces alces_ in their case). Briefly, this 'non-movement method' identifies implausible segments of a trajectory, and removes them. Here, we adopt elements of their method to identify and remove 'spikes' in the movement track, i.e., positions which indicate an improbably fast and short excursion away from the real trajectory.

We begin by calculating the speed and turning angle along the track. For both metrics, the first value is set at `NA`, indicating that we do not know the position of the individual prior to the start of the trajectory. The turning angle is calculated using the cosine rule and requires three positions to yield a values; thus it has an `NA` at the very last position as well.

```{r}
# get speed and turning angle
data_many_nbs[, `:=`(in_speed = atl_get_speed(data_many_nbs),
                     out_speed = c(atl_get_speed(data_many_nbs)[-1], NA),
                     angle = atl_turning_angle(data_many_nbs))]

```

Next we idenfify the 90th and 95th percentile of speed and turning angle. This is more general than identifying the limits of implausibility for each individual (since there may be inter-individual differences), let alone each species in a large dataset.
An alternative approach is to define a speed cutoff based on expert knowledge, and this is best suited to well studied species.

```{r}
# get 90 and 95 percentile of speed and turning angle
sapply(data_many_nbs[, c("in_speed", "angle")], function(z) {
  quantile(z, probs = c(0.9, 0.95), na.rm = TRUE)
})
```

Finally, we remove positions whose incoming and outgoing speeds are both greater than the 95th speed percentile.

```{r}
# make a copy of the data
data_non_move <- copy(data_many_nbs)

# filter the copy
data_non_move <- atl_filter_covariates(data_non_move,
                                       filters = c("in_speed < 0.0012",
                                                   "out_speed < 0.0012",
                                                   "angle < 40"))
```

## Reflections: Challenges to the non-movement approach

A curious issue affecting TOA tracking systems is the phenomenon of ‘reflected’ positions, in which the estimated location is instantaneously displaced many hundreds of metres from the individual’s real position for some time, followed by a return to the real position.

These reflections cannot be resolved in the same way as spikes, since they consist of several points with very realistic speeds bookended by a pair with either an extreme incoming or outgoing speed.

A reflection appears thus:

```{r}
# make a copy of data with spikes removed
data_with_reflection <- copy(data_non_move)

# add a reflection
data_with_reflection[500:600, c("x", "y") := runif(101, min = 1, max = 1.1)]
```


Removing reflections involves using the phenomenon’s properties to first identify its bounds and then removing all positions between these bounds.

The procedure is as follows:

1. Identify positions with anomalous (usually extremely high) speeds and turning angles, as with spikes, and

2. Split the trajectory into pre- and post-anomaly segments, and the first position of the post-anomaly segment, which is the inner bound of the reflection, can be set as an anchor point.

3. The first position after the anchor point with an instantaneous outgoing speed >= the speed cutoff is set as the outer bound of the reflection.

4. The positions between these bounds can be identified as a trajectory reflection and removed, along with one position before and after the bounds for safety's sake.

This method is robust to variable displacement of the reflections from the real positions, and also to displacement in the real position of the individual itself.


```{r}
# attempt to remove reflections
data_no_reflections <- copy(data_with_reflection)

data_no_reflections <- atl_remove_reflections(data_with_reflection,
                                              point_angle_cutoff = 40,
                                              reflection_speed_cutoff = 0.0012)
```

